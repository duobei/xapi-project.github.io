<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta name=generator content="Relearn 5.20.0+tip"><meta name=description content><title>Host memory accounting :: XAPI Toolstack Developer Documentation</title><link href=/new-docs/images/favicon.png?1697799548 rel=icon type=image/png><link href=/new-docs/css/fontawesome-all.min.css?1697799548 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/fontawesome-all.min.css?1697799548 rel=stylesheet></noscript><link href=/new-docs/css/nucleus.css?1697799548 rel=stylesheet><link href=/new-docs/css/auto-complete.css?1697799548 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/auto-complete.css?1697799548 rel=stylesheet></noscript><link href=/new-docs/css/perfect-scrollbar.min.css?1697799548 rel=stylesheet><link href=/new-docs/css/fonts.css?1697799548 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/fonts.css?1697799548 rel=stylesheet></noscript><link href=/new-docs/css/theme.css?1697799548 rel=stylesheet><link href=/new-docs/css/theme-red.css?1697799548 rel=stylesheet id=variant-style><link href=/new-docs/css/variant.css?1697799548 rel=stylesheet><link href=/new-docs/css/print.css?1697799548 rel=stylesheet media=print><link href=/new-docs/css/ie.css?1697799548 rel=stylesheet><script src=/new-docs/js/url.js?1697799548></script>
<script src=/new-docs/js/variant.js?1697799548></script>
<script>window.index_js_url="/new-docs/index.search.js";var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \"{0}\"",window.T_N_results_found="{1} results found for \"{0}\"",baseUriFull="https://xapi-project.github.io/new-docs/",window.variants&&variants.init(["red"])</script></head><body class="mobile-support html" data-url=/new-docs/xapi/memory/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div class=navigation><a class="nav nav-next topbar-link" href=/new-docs/xcp-networkd/index.html title="Networkd (&#129106;)"><i class="fas fa-chevron-right fa-fw"></i></a></div><div class=navigation><a class="nav nav-prev topbar-link" href=/new-docs/xapi/guides/howtos/add-api-extension/index.html title="Adding a XenAPI extension (&#129104;)"><i class="fas fa-chevron-left fa-fw"></i></a></div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span>
<span id=toc-menu title='Table of Contents (CTRL+ALT+t)'><i class="fas fa-list-alt fa-fw"></i></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/new-docs/index.html><span itemprop=name>XAPI Toolstack Developer Guide</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/new-docs/xapi/index.html><span itemprop=name>Xapi</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Host memory accounting</span><meta itemprop=position content="3"></li></ol></div><div class="default-animation progress"><div class=toc-wrapper><nav id=TableOfContents><ul><li><a href=#host-overhead>Host overhead</a></li><li><a href=#vm-overhead>VM overhead</a></li><li><a href=#memory-required-to-start-a-vm>Memory required to start a VM</a></li><li><a href=#memory-required-to-migrate-a-vm>Memory required to migrate a VM</a></li></ul></nav></div></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=host-memory-accounting>Host memory accounting</h1><p>Memory is used for many things:</p><ul><li>the hypervisor code: this is the Xen executable itself</li><li>the hypervisor heap: this is needed for per-domain structures and per-vCPU
structures</li><li>the crash kernel: this is needed to collect information after a host crash</li><li>domain RAM: this is the memory the VM believes it has</li><li>shadow memory: for HVM guests running on hosts without hardware assisted
paging (HAP) Xen uses shadow to optimise page table updates. For all guests
shadow is used during live migration for tracking the memory transfer.</li><li>video RAM for the virtual graphics card</li></ul><p>Some of these are constants (e.g. hypervisor code) while some depend on the VM
configuration (e.g. domain RAM). Xapi calls the constants &ldquo;host overhead&rdquo; and
the variables due to VM configuration as &ldquo;VM overhead&rdquo;. There is no low-level
API to query this information, therefore xapi will sample the host overheads
at system boot time and model the per-VM overheads.</p><h2 id=host-overhead>Host overhead</h2><p>The host overhead is not managed by xapi, instead it is sampled. After the host
boots and before any VMs start, xapi asks Xen how much memory the host has in
total, and how much memory is currently free. Xapi subtracts the free from the
total and stores this as the host overhead.</p><h2 id=vm-overhead>VM overhead</h2><p>The inputs to the model are</p><ul><li><code>VM.memory_static_max</code>: the maximum amount of RAM the domain will be able to use</li><li><code>VM.HVM_shadow_multiplier</code>: allows the shadow memory to be increased</li><li><code>VM.VCPUs_max</code>: the maximum number of vCPUs the domain will be able to use</li></ul><p>First the shadow memory is calculated, in MiB</p><p><a href=#image-9e3d3683bb7425cf1721673f4fe54c25 class=lightbox-link><img src=/new-docs/xapi/memory/shadow.svg alt="Shadow memory in MiB" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=image-9e3d3683bb7425cf1721673f4fe54c25><img src=/new-docs/xapi/memory/shadow.svg alt="Shadow memory in MiB" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>Second the VM overhead is calculated, in MiB</p><p><a href=#image-424f88668ec3a8baca64b9b0b4fb1ef4 class=lightbox-link><img src=/new-docs/xapi/memory/overhead.svg alt="Memory overhead in MiB" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=image-424f88668ec3a8baca64b9b0b4fb1ef4><img src=/new-docs/xapi/memory/overhead.svg alt="Memory overhead in MiB" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><h2 id=memory-required-to-start-a-vm>Memory required to start a VM</h2><p>If ballooning is disabled, the memory required to start a VM is the same as the VM
overhead above.</p><p>If ballooning is enabled then the memory calculation above is modified to use the
<code>VM.memory_dynamic_max</code> rather than the <code>VM.memory_static_max</code>.</p><h2 id=memory-required-to-migrate-a-vm>Memory required to migrate a VM</h2><p>If ballooning is disabled, the memory required to receive a migrating VM is the same
as the VM overhead above.</p><p>If ballooning is enabled, then the VM will first be ballooned down to <code>VM.memory_dynamic_min</code>
and then it will be migrated across. If the VM fails to balloon all the way down, then
correspondingly more memory will be required on the receiving side.</p><footer class=footline></footer></article></div></main></div><aside id=sidebar class=default-animation><div id=header-topbar class=default-animation></div><div id=header-wrapper class=default-animation><div id=header class=default-animation><img src=https://xapi-project.github.io/new-docs//images/xapi-project.png></div><div class="searchbox default-animation"><i class="fas fa-search" title="Search (CTRL+ALT+f)"></i>
<label class=a11y-only for=search-by>Search</label>
<input data-search-input id=search-by name=search-by class=search-by type=search placeholder=Search...>
<button class=search-clear type=button data-search-clear title="Clear search"><i class="fas fa-times" title="Clear search"></i></button></div><script>var contentLangs=["en"]</script><script src=/new-docs/js/auto-complete.js?1697799548 defer></script>
<script src=/new-docs/js/lunr/lunr.min.js?1697799548 defer></script>
<script src=/new-docs/js/lunr/lunr.stemmer.support.min.js?1697799548 defer></script>
<script src=/new-docs/js/lunr/lunr.multi.min.js?1697799548 defer></script>
<script src=/new-docs/js/lunr/lunr.en.min.js?1697799548 defer></script>
<script src=/new-docs/js/search.js?1697799548 defer></script></div><div id=homelinks class="default-animation homelinks"><ul><li><a class=padding href=/new-docs/index.html><i class="fas fa-home"></i> Home</a></li></ul><hr class=padding></div><div id=content-wrapper class=highlightable><div id=topics><ul class="enlarge morespace collapsible-menu"><li data-nav-id=/new-docs/toolstack/index.html><input type=checkbox id=section-733bfb8b221c6a3949d666444cf4445d aria-controls=subsections-733bfb8b221c6a3949d666444cf4445d><label for=section-733bfb8b221c6a3949d666444cf4445d><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu The Toolstack</span></label><a class=padding href=/new-docs/toolstack/index.html>The Toolstack</a><ul id=subsections-733bfb8b221c6a3949d666444cf4445d class="morespace collapsible-menu"><li data-nav-id=/new-docs/toolstack/responsibilities/index.html><a class=padding href=/new-docs/toolstack/responsibilities/index.html>Responsibilities</a></li><li data-nav-id=/new-docs/toolstack/high-level/index.html><input type=checkbox id=section-93d1c0b933c799c336ad0fd09a6dc0ae aria-controls=subsections-93d1c0b933c799c336ad0fd09a6dc0ae><label for=section-93d1c0b933c799c336ad0fd09a6dc0ae><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu High-level architecture</span></label><a class=padding href=/new-docs/toolstack/high-level/index.html>High-level architecture</a><ul id=subsections-93d1c0b933c799c336ad0fd09a6dc0ae class="morespace collapsible-menu"><li data-nav-id=/new-docs/toolstack/high-level/environment/index.html><a class=padding href=/new-docs/toolstack/high-level/environment/index.html>Environment</a></li><li data-nav-id=/new-docs/toolstack/high-level/daemons/index.html><a class=padding href=/new-docs/toolstack/high-level/daemons/index.html>Daemons</a></li><li data-nav-id=/new-docs/toolstack/high-level/interfaces/index.html><a class=padding href=/new-docs/toolstack/high-level/interfaces/index.html>Interfaces</a></li></ul></li><li data-nav-id=/new-docs/toolstack/features/index.html><input type=checkbox id=section-a202420b9d8f13c2d690377c4357de50 aria-controls=subsections-a202420b9d8f13c2d690377c4357de50><label for=section-a202420b9d8f13c2d690377c4357de50><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu Features</span></label><a class=padding href=/new-docs/toolstack/features/index.html>Features</a><ul id=subsections-a202420b9d8f13c2d690377c4357de50 class="morespace collapsible-menu"><li data-nav-id=/new-docs/toolstack/features/DR/index.html><a class=padding href=/new-docs/toolstack/features/DR/index.html>Disaster Recovery</a></li><li data-nav-id=/new-docs/toolstack/features/HA/index.html><a class=padding href=/new-docs/toolstack/features/HA/index.html>High-Availability</a></li><li data-nav-id=/new-docs/toolstack/features/snapshots/index.html><a class=padding href=/new-docs/toolstack/features/snapshots/index.html>Snapshots</a></li><li data-nav-id=/new-docs/toolstack/features/VGPU/index.html><a class=padding href=/new-docs/toolstack/features/VGPU/index.html>vGPU</a></li><li data-nav-id=/new-docs/toolstack/features/XSM/index.html><a class=padding href=/new-docs/toolstack/features/XSM/index.html>Xapi Storage Migration</a></li></ul></li></ul></li><li data-nav-id=/new-docs/xapi/index.html class=parent><input type=checkbox id=section-38d9a208f329bfd7f57b7a3d82b1b09a aria-controls=subsections-38d9a208f329bfd7f57b7a3d82b1b09a checked><label for=section-38d9a208f329bfd7f57b7a3d82b1b09a><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu Xapi</span></label><a class=padding href=/new-docs/xapi/index.html>Xapi</a><ul id=subsections-38d9a208f329bfd7f57b7a3d82b1b09a class="morespace collapsible-menu"><li data-nav-id=/new-docs/xapi/guides/index.html><input type=checkbox id=section-1e852a9c61356e39c38ffde6aaccdadf aria-controls=subsections-1e852a9c61356e39c38ffde6aaccdadf><label for=section-1e852a9c61356e39c38ffde6aaccdadf><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu Guides</span></label><a class=padding href=/new-docs/xapi/guides/index.html>Guides</a><ul id=subsections-1e852a9c61356e39c38ffde6aaccdadf class="morespace collapsible-menu"><li data-nav-id=/new-docs/xapi/guides/howtos/index.html><input type=checkbox id=section-259bbbeab1560e4f0d61ad99041ab23f aria-controls=subsections-259bbbeab1560e4f0d61ad99041ab23f><label for=section-259bbbeab1560e4f0d61ad99041ab23f><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu How to add....</span></label><a class=padding href=/new-docs/xapi/guides/howtos/index.html>How to add....</a><ul id=subsections-259bbbeab1560e4f0d61ad99041ab23f class="morespace collapsible-menu"><li data-nav-id=/new-docs/xapi/guides/howtos/add-class/index.html><a class=padding href=/new-docs/xapi/guides/howtos/add-class/index.html>Adding a Class to the API</a></li><li data-nav-id=/new-docs/xapi/guides/howtos/add-field/index.html><a class=padding href=/new-docs/xapi/guides/howtos/add-field/index.html>Adding a field to the API</a></li><li data-nav-id=/new-docs/xapi/guides/howtos/add-function/index.html><a class=padding href=/new-docs/xapi/guides/howtos/add-function/index.html>Adding a function to the API</a></li><li data-nav-id=/new-docs/xapi/guides/howtos/add-api-extension/index.html><a class=padding href=/new-docs/xapi/guides/howtos/add-api-extension/index.html>Adding a XenAPI extension</a></li></ul></li></ul></li><li data-nav-id=/new-docs/xapi/memory/index.html class=active><a class=padding href=/new-docs/xapi/memory/index.html>Memory</a></li></ul></li><li data-nav-id=/new-docs/xcp-networkd/index.html><a class=padding href=/new-docs/xcp-networkd/index.html>Networkd</a></li></ul></div><div class="padding footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter"></div><div id=menu-footer><hr class="padding default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter"><div id=prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks"><ul><li id=select-language-container class=footerLangSwitch><div class="padding menu-control"><i class="fas fa-language fa-fw"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=select-language>Language</label>
<select id=select-language onchange="location=baseUri+this.value"></select></div><div class=clear></div></div></li><li id=select-variant-container class=footerVariantSwitch><div class="padding menu-control"><i class="fas fa-paint-brush fa-fw"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=select-variant>Theme</label>
<select id=select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=red value=red selected>Red</option></select></div><div class=clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class=footerVisitedLinks><div class="padding menu-control"><i class="fas fa-history fa-fw"></i>
<span>&nbsp;</span><div class=control-style><button onclick=clearHistory()>Clear History</button></div><div class=clear></div></div></li></ul></div><div id=footer class=footerFooter></div></div></div></aside><script src=/new-docs/js/clipboard.min.js?1697799548 defer></script>
<script src=/new-docs/js/perfect-scrollbar.min.js?1697799548 defer></script>
<script src=/new-docs/js/theme.js?1697799548 defer></script></body></html>